services:
  ipfs:
    image: ipfs/go-ipfs:latest
    container_name: healthcare_ipfs
    restart: unless-stopped
    ports:
      - "5001:5001"
      - "8080:8080"
    environment:
      - IPFS_TELEMETRY=off
    volumes:
      - ipfs_data:/data/ipfs
    healthcheck:
      test: ["CMD-SHELL", "ipfs --api=/ip4/127.0.0.1/tcp/5001 id > /dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 5s
      start_period: 120s
      retries: 20
    networks:
      - healthcare_network

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: healthcare_backend
    restart: unless-stopped
    ports:
      - "3000:3000"
    env_file: .env
    depends_on:
      ipfs:
        condition: service_healthy
    volumes:
      - ./scripts/wait-for-services.sh:/app/wait-for-services.sh:ro
      - ./cert.pem:/app/cert.pem:ro
      - ./key.pem:/app/key.pem:ro
    command: ["/bin/sh", "-c", "/app/wait-for-services.sh ipfs /usr/local/bin/app"]
    networks:
      - healthcare_network

volumes:
  ipfs_data: {}

networks:
  healthcare_network:
    driver: bridge
